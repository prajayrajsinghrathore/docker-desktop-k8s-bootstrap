# NetworkPolicy: Allow DNS queries to kube-dns
#
# IDEMPOTENCY: Safe to apply multiple times (kubectl apply -f)
#   - Creates resource if missing
#   - Updates to desired state if exists
#
# PURPOSE: Essential for service discovery
#   - Without DNS, pods cannot resolve service names
#   - This allows pods to query kube-dns (CoreDNS) in kube-system
#   - Required even in a locked-down namespace
#
# SECURITY:
#   - Only allows UDP/TCP port 53 to kube-dns
#   - Does not allow other egress (handled by separate policies)
#   - Scoped to kube-system namespace only
#
# SCOPE: Namespace-level (platform-dev only)
#   - podSelector: {} means "all pods in this namespace"
#   - Only affects egress to kube-system namespace on DNS port
#
# COMPATIBILITY:
#   - Works with Docker Desktop's CoreDNS
#   - Works with most Kubernetes distributions
#   - Uses label selector for kube-dns service
#
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: platform-dev
  labels:
    app.kubernetes.io/managed-by: bootstrap-script
    app.kubernetes.io/part-of: platform-security
spec:
  # Empty podSelector = applies to all pods in namespace
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries to kube-dns in kube-system namespace
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        # DNS over UDP (standard)
        - protocol: UDP
          port: 53
        # DNS over TCP (for large responses)
        - protocol: TCP
          port: 53
